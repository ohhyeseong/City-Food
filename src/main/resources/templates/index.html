<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CityFood — 메인</title>
  <!-- CSS 스타일을 별도의 <style> 태그 안에서 관리 -->
  <style>
    /* CSS 사용자 정의 속성 정의 */
    :root {
      --brand: #2b7cff;
      --bg: #f7f9fc;
      --text: #222;
      --muted: #666;
      --card: #fff;
      --border: #e6eaf2;
    }
    /* 모든 요소에 박스 사이징 적용 */
    * {
      box-sizing: border-box;
    }
    /* 기본 바디 스타일 */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      color: var(--text);
      background: var(--bg);
    }
    /* 헤더 스타일 */
    header {
      background: #fff;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    /* 중앙 정렬용 래퍼 */
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 16px;
    }
    /* 네비게이션 바 스타일 */
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
    }
    /* 브랜드 이름 스타일 */
    .brand {
      color: var(--brand);
      font-weight: 700;
      text-decoration: none;
    }
    /* 메뉴 링크 스타일 */
    .menu a {
      color: #333;
      text-decoration: none;
      margin-left: 12px;
    }
    /* 메인 컨텐츠 영역 스타일 */
    main {
      padding: 24px 0;
    }
    /* 카드 형태 스타일 */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    /* 그리드 레이아웃 (행) */
    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    /* 미디어 쿼리 (900px 이상일 때 두 컬럼 형태) */
    @media (min-width: 900px) {
      .row {
        grid-template-columns: 1fr 1fr;
      }
    }
    /* 레이블 스타일 */
    label {
      display: block;
      font-size: 14px;
      margin: 10px 0 6px;
      color: #333;
    }
    /* 입력창, 선택창, 텍스트 에어리어 스타일 */
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }
    /* 버튼 스타일 */
    button {
      background: var(--brand);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }
    /* 비활성화 된 버튼 스타일 */
    button:disabled {
      background: #aac9ff;
      cursor: not-allowed;
    }
    /* 목록 리스트 스타일 */
    .list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    /* 리스트 아이템 스타일 */
    .item {
      border-bottom: 1px solid var(--border);
      padding: 12px 0;
    }
    /* 마지막 아이템의 보더 제거 */
    .item:last-child {
      border-bottom: none;
    }
    /* 설명 문구 스타일 */
    .muted {
      color: var(--muted);
      font-size: 12px;
    }
    /* 푸터 스타일 */
    footer {
      color: #555;
      padding: 24px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
<!-- 헤더 섹션 시작 -->
<header>
  <div class="wrap">
    <div class="nav">
      <!-- 브랜드 네임 -->
      <a href="#" class="brand">CityFood — 메인</a>
      <!-- 메뉴 영역 (필요시 링크 추가) -->
      <div class="menu">
        <!-- 예시 링크 -->
        <a href="#">홈</a>
        <a href="#">맛집 목록</a>
      </div>
    </div>
  </div>
</header>
<!-- 헤더 섹션 끝 -->

<!-- 메인 컨텐츠 시작 -->
<main class="wrap">
  <!-- 맛집 등록 폼 시작 -->
  <section class="card">
    <h2>맛집 등록</h2>
    <form id="createForm">
      <!-- 이름 입력 -->
      <label for="name">이름</label>
      <input type="text" id="name" name="name" placeholder="맛집 이름 입력">

      <!-- 카테고리 입력 -->
      <label for="category">카테고리</label>
      <input type="text" id="category" name="category" placeholder="카테고리 입력">

      <!-- 주소 입력 -->
      <label for="address">주소</label>
      <input type="text" id="address" name="address" placeholder="주소 입력">

      <!-- 전화번호 입력 -->
      <label for="phone">전화번호</label>
      <input type="tel" id="phone" name="phone" placeholder="전화번호 입력">

      <!-- 설명 입력 -->
      <label for="description">설명</label>
      <textarea id="description" name="description" placeholder="맛집 설명 입력" rows="3"></textarea>

      <!-- 지역 슬러그 선택 -->
      <label for="regionSlug">지역 슬러그</label>
      <select id="regionSlug" name="regionSlug">
        <option value="" selected>선택하세요</option>
        <!--/* Thymeleaf로 regions 리스트를 순회하며 option 태그 생성 */-->
        <option th:each="region : ${regions}" th:value="${region.slug}" th:text="${region.name}"></option>
      </select>

      <!-- 등록 및 초기화 버튼 -->
      <div style="margin-top: 16px;">
        <button type="submit">등록</button>
        <button type="reset" style="margin-left: 8px;">초기화</button>
      </div>
    </form>
  </section>
  <!-- 맛집 등록 폼 끝 -->

  <!-- 맛집 목록 (검색 및 리스트) 섹션 시작 -->
  <section id="list" class="card">
    <h2 style="margin:0 0 12px;">맛집 목록</h2>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <input id="keyword" placeholder="키워드(이름)">
      <select id="regionId">
        <option value="" selected>지역 전체</option>
        <!--/* Thymeleaf로 regions 리스트를 순회하며 option 태그 생성 */-->
        <option th:each="region : ${regions}" th:value="${region.id}" th:text="${region.name}"></option>
      </select>
      <button id="searchBtn" type="button">검색</button>
    </div>
    <ul id="placeList" class="list"></ul>
    <p id="listMsg" class="muted" style="margin-top:8px;"></p>
    <!-- 페이지네이션 버튼이 표시될 컨테이너 -->
    <div id="pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
  </section>
  <!-- 맛집 목록 섹션 끝 -->
</main>
<!-- 메인 컨텐츠 끝 -->

<!-- 푸터 섹션 시작 -->
<footer class="wrap">
  © CityFood
</footer>
<!-- 푸터 섹션 끝 -->

<script>
  // 맛집 등록 폼 제출 스크립트
  const createForm = document.getElementById('createForm');

  createForm.addEventListener('submit', async (e) => {
    e.preventDefault(); // 폼의 기본 제출 동작(페이지 이동)을 막습니다.

    const formData = new FormData(createForm);
    const data = Object.fromEntries(formData.entries());

    try {
      // '/api/places' 주소로 JSON 데이터를 POST 방식으로 보냅니다.
      const response = await fetch('/api/places', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        alert('맛집이 성공적으로 등록되었습니다!');
        createForm.reset(); // 성공 시 폼의 내용을 초기화합니다.
        fetchAndRenderPlaces(); // 등록 성공 후 목록을 새로고침합니다. (첫 페이지로)
      } else {
        const errorData = await response.json();
        alert('등록에 실패했습니다: ' + (errorData.message || '서버 오류가 발생했습니다.'));
      }
    } catch (error) {
      console.error('맛집 등록 중 오류 발생:', error);
      alert('요청 중 오류가 발생했습니다. 콘솔을 확인해주세요.');
    }
  });

  // --- 맛집 목록 조회 및 검색 스크립트 ---

  // 필요한 HTML 요소들을 가져옵니다.
  const searchBtn = document.getElementById('searchBtn');
  const keywordInput = document.getElementById('keyword');
  const regionIdSelect = document.getElementById('regionId');
  const placeList = document.getElementById('placeList');
  const listMsg = document.getElementById('listMsg');

  // 서버에 맛집 목록을 요청하고 화면에 렌더링하는 함수 (페이지 번호 추가)
  const fetchAndRenderPlaces = async (page = 0) => {
    const keyword = keywordInput.value;
    const regionId = regionIdSelect.value;

    // URL 쿼리 스트링을 만듭니다 (예: ?keyword=강남&regionId=1)
    const query = new URLSearchParams({
      page, // 페이지 번호 추가
      size: 5, // 한 페이지에 5개씩 표시
      // 값이 있을 때만 쿼리에 추가합니다.
      ...(keyword && { keyword }),
      ...(regionId && { regionId }),
    }).toString();

    try {
      const response = await fetch(`/api/places?${query}`);
      if (!response.ok) throw new Error('데이터 로딩 실패');
      const pageData = await response.json(); // Page 객체로 응답을 받습니다.
      const places = pageData.content; // 실제 데이터는 content 속성에 있습니다.

      placeList.innerHTML = ''; // 기존 목록을 초기화합니다.

      if (places.length === 0) {
        listMsg.textContent = '검색 결과가 없습니다.';
      } else {
        listMsg.textContent = `총 ${pageData.totalElements}개의 맛집 중 ${places.length}개를 표시합니다.`;
        places.forEach(place => {
          const li = document.createElement('li');
          li.className = 'item';
          li.innerHTML = `
            <div>
              <strong>${place.name}</strong> <span class="muted">(${place.category})</span>
              <p class="muted" style="margin:4px 0 0;">${place.address}</p>
            </div>
          `;
          placeList.appendChild(li);
        });
      }
      renderPagination(pageData); // 페이지네이션 버튼을 렌더링합니다.
    } catch (error) {
      console.error('맛집 목록 조회 오류:', error);
      listMsg.textContent = '목록을 불러오는 중 오류가 발생했습니다.';
    }
  };

  // 페이지네이션 버튼을 생성하는 함수
  const renderPagination = (pageData) => {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = ''; // 기존 버튼을 초기화합니다.

    // '이전' 버튼
    if (!pageData.first) {
      const prevBtn = document.createElement('button');
      prevBtn.textContent = '이전';
      prevBtn.onclick = () => fetchAndRenderPlaces(pageData.number - 1);
      pagination.appendChild(prevBtn);
    }

    // '다음' 버튼
    if (!pageData.last) {
      const nextBtn = document.createElement('button');
      nextBtn.textContent = '다음';
      nextBtn.onclick = () => fetchAndRenderPlaces(pageData.number + 1);
      pagination.appendChild(nextBtn);
    }
  }

  // 검색 버튼 클릭 시 첫 페이지부터 다시 검색합니다.
  searchBtn.addEventListener('click', () => fetchAndRenderPlaces(0));

  // 페이지가 처음 로드될 때 전체 목록을 불러옵니다.
  document.addEventListener('DOMContentLoaded', fetchAndRenderPlaces);
</script>
</body>
</html>